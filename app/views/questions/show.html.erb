<%= render 'header' %>

<% if notice %>
  <p class="alert alert-primary" role="alert"><%= notice %></p>
<% end %>
<div class='container'>
  <div class='pb-2 border-bottom border-danger'>
    <div class="card text-white bg-danger mb-3">
      <div class="card-header">
        <%= @question.title %>
      </div>
      <div class="card-body">
        <p class="card-text"><%= markdown(@question.body) %></p>
        <footer class="text-right "><%= link_to "@" + @question.user.username, @question.user, :class => 'text-white' %></footer>
      </div>
      <div class="card-footer">
        <small>Last updated
          <% if (Time.now - @question.updated_at).to_i < 60 %>
            <%= (Time.now - @question.created_at).to_i %> sec. ago
          <% elsif (Time.now - @question.updated_at).to_i < 3600 %>
            <%= (Time.now - @question.created_at).to_i / 60 %> min. ago
          <% elsif (Time.now - @question.updated_at).to_i < (3600 * 48) %>
            <%= (Time.now - @question.created_at).to_i / 3600 %> hr. ago
          <% else %>
            <%= (Time.now - @question.updated_at).to_i / (3600 * 24) %> days ago
          <% end %></small>
      </div>
    </div>
  </div>

<% if @question.accepted_answer %>
  <h2>Accepted Answer</h2>
  <table>
    <thead>
      <tr>
        <th>Body</th>
        <th>User</th>
        <th colspan="3"></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><%= @question.accepted_answer.body %></td>
        <td><%= @question.accepted_answer.user.username %></td>
        <td><%= link_to 'Edit', edit_question_answer_path(@question.accepted_answer) %></td>
        <td><%= link_to 'Destroy', question_answer_path(@question, @question.accepted_answer),
        method: :delete, data: { confirm: 'Are you sure?' } %></td>
        <td><%= link_to 'Reject Answer',
        question_answer_path(@question, @question.accepted_answer, {:format => :html, :question_accepted_id => nil}),
        method: :patch %></td>
      </tr>
    </tbody>
  </table>
<% end %>

<h2>Other Answers</h2>

<table>
  <thead>
    <tr>
      <th>Body</th>
      <th>User</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @question.answers.each do |answer| %>
      <% unless answer.question_accepted_id %>
        <tr>
          <td><%= answer.body %></td>
          <td><%= answer.user.username %></td>
          <td><%= link_to 'Edit', edit_question_answer_path(answer) %></td>
          <td><%= link_to 'Destroy', question_answer_path(@question, answer),
          method: :delete, data: { confirm: 'Are you sure?' } %></td>
          <td><%= link_to 'Accept Answer',
          question_answer_path(@question, answer, {:format => :html, :question_accepted_id => @question.id}),
          method: :patch %></td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

  <h2 class='mt-3'>Answers</h2>

  <% if current_user %>
    <div class='pb-2 border-bottom border-danger'>
      <%= form_with(url: question_answers_path(@question).html_safe, local: true, :html => {:class => ''}) do |form| %>

        <div class="form-group">
          <%= form.text_area :body, :class => 'form-control' %>
        </div>

        <%= form.hidden_field :user_id, :value => current_user.id %>
        <%= form.hidden_field :question_id, :value => @question.id %>

        <div class="actions">
          <%= form.submit :class => "btn btn-danger btn-block" %>
        </div>
      <% end %>
    </div>
  <% end %>

  <% @answers.sort_by(&:created_at).each do |answer| %>

    <div class='py-2 border-bottom border-danger'>
      <% if false %>
        <div class="card text-white bg-primary">
      <% else %>
        <div class="card">
      <% end %>
      <div class="card-body">
        <p class="card-text"><%= markdown(answer.body).html_safe %></p>
        <footer class="text-right "><%= link_to "@" + answer.user.username, answer.user, :class => 'text-dark' %></footer>
      </div>
      <div class="card-footer">
        <small>Last updated
          <% if (Time.now - answer.updated_at).to_i < 60 %>
            <%= (Time.now - answer.created_at).to_i %> sec. ago
          <% elsif (Time.now - answer.updated_at).to_i < 3600 %>
            <%= (Time.now - answer.created_at).to_i / 60 %> min. ago
          <% elsif (Time.now - answer.updated_at).to_i < (3600 * 48) %>
            <%= (Time.now - answer.created_at).to_i / 3600 %> hr. ago
          <% else %>
            <%= (Time.now - answer.updated_at).to_i / (3600 * 24) %> days ago
          <% end %></small>
      </div>
      </div>

      </div>
  <% end %>
  </div>
</div>